let i=null;chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"open-in-flowreader",title:"Open in FlowReader",contexts:["page","selection"]}),chrome.commands.getAll(e=>{for(const{name:t,shortcut:r}of e)r===""?console.warn(`FlowReader: Command "${t}" has no shortcut assigned! Check chrome://extensions/shortcuts`):console.log(`FlowReader: Command "${t}" registered with shortcut: ${r}`)})});chrome.contextMenus.onClicked.addListener(async(e,t)=>{e.menuItemId==="open-in-flowreader"&&t?.id&&await d(t.id,e.selectionText)});chrome.runtime.onMessage.addListener((e,t,r)=>{switch(e.type){case"OPEN_READER":i=e.document,c();break;case"GET_PENDING_DOCUMENT":r(i),i=null;break;case"EXTRACT_FROM_URL":return w(e.url).then(o=>{r(o)}).catch(o=>{r({error:o.message})}),!0}return!0});chrome.commands.onCommand.addListener(async e=>{if(console.log("FlowReader: Command received:",e),e==="open-reader")try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});console.log("FlowReader: Active tab:",t?.id,t?.url),t?.id?await d(t.id):console.error("FlowReader: No active tab found for keyboard shortcut")}catch(t){console.error("FlowReader: Error handling keyboard shortcut:",t)}});chrome.action.onClicked.addListener(async e=>{e.id&&await d(e.id)});function l(e){return!e||e.startsWith("chrome://")||e.startsWith("chrome-extension://")||e.startsWith("edge://")||e.startsWith("about:")||e.startsWith("moz-extension://")||e.startsWith("file://")}async function h(e){try{const t=await chrome.tabs.get(e);return!t.url||l(t.url)?(console.warn("Cannot inject into restricted URL:",t.url),!1):(await chrome.scripting.executeScript({target:{tabId:e},func:()=>{console.log("FlowReader: Content script injection attempted")}}),await new Promise(r=>setTimeout(r,100)),!0)}catch(t){return console.warn("Failed to inject content script:",t),!1}}async function u(e,t){try{return await chrome.tabs.sendMessage(e,t)}catch{console.log("FlowReader: Content script not responding, attempting injection...")}if(!await h(e))return console.warn("FlowReader: Could not inject content script. Try refreshing the page."),null;await new Promise(o=>setTimeout(o,200));try{return await chrome.tabs.sendMessage(e,t)}catch{return console.error("FlowReader: Content script still not responding after injection. Please refresh the page."),null}}async function d(e,t){try{if(!e){const[n]=await chrome.tabs.query({active:!0,currentWindow:!0});e=n.id}if(!e){console.error("No active tab found");return}if(t&&t.trim().length>50){i={metadata:{title:"Selected Text",source:"selection",createdAt:Date.now()},blocks:t.split(/\n\n+/).filter(n=>n.trim()).map((n,s)=>({type:"paragraph",content:n.trim(),id:`block-${s}`})),plainText:t},c();return}const o=(await chrome.tabs.get(e)).url||"";if(l(o)){console.warn("Cannot extract from restricted URL:",o),c();return}const a=await u(e,{type:"EXTRACT_CONTENT"});if(!a){console.error("Could not communicate with content script"),i=null,c();return}a.type==="CONTENT_EXTRACTED"?(i=a.payload,c()):a.type==="EXTRACTION_FAILED"&&(console.error("Extraction failed:",a.error),c())}catch(r){console.error("Error extracting content:",r),c()}}function c(){const e=chrome.runtime.getURL("src/reader/index.html");chrome.tabs.create({url:e})}async function w(e){if(!e||l(e))throw new Error("Cannot extract from this URL");const t=await chrome.tabs.create({url:e,active:!1});if(!t.id)throw new Error("Failed to create tab");await new Promise((r,o)=>{const a=setTimeout(()=>{o(new Error("Page load timeout"))},15e3),n=(s,m)=>{s===t.id&&m.status==="complete"&&(chrome.tabs.onUpdated.removeListener(n),clearTimeout(a),r())};chrome.tabs.onUpdated.addListener(n)});try{const r=await u(t.id,{type:"EXTRACT_CONTENT"});if(r?.type==="CONTENT_EXTRACTED")return r.payload;throw new Error("Failed to extract content")}finally{t.id&&chrome.tabs.remove(t.id)}}
